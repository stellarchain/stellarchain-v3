{% extends 'base.html.twig' %}

{% block title %}{{post.title}}{% endblock %}

{% set content_title = post.title %}

{% import 'macros/comment.html.twig' as comment_template %}

{% block body %}
<div class="vh-100 overflow-y-scroll overflow-x-hidden hide-scrollbar">
    {% include 'content-header.html.twig' with {'right_block': false , 'center_title': true} %}
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card card-body">
                {{post.body}}
            </div>
            <div class="container my-5">
                <div class="mb-4" id="post-form-content">
                    {% block comment_form_block %}
                       {% include 'blocks/comment_form_block.html.twig' with { 'form': comment_form } %}
                    {% endblock %}
                </div>

                <div id="comments-list" {{ turbo_stream_listen('comments-list-' ~ post.id) }}>
                    {% set prev_comment_id = null %}
                    {% for index, comment_data in comments %}
                        {% set next_comment_id = (index + 1 < comments|length) ? comments[index + 1].comment.id : null %}
                        {% set root_comment = comment_data.comment.parent is null ? comment_data : root_comment ?? comment_data %}
                        {{ comment_template.render_comment(comment_data, root_comment, prev_comment_id, next_comment_id) }}
                        {% set prev_comment_id = comment_data.comment.id %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block create_comment %}
{% import 'macros/comment.html.twig' as comment_template %}

<turbo-stream action="replace" targets="form[name=comment_form]">
    <template>
        {{block('comment_form_block')}}
    </template>
</turbo-stream>

<turbo-stream action="prepend" target="comments-list" >
    <template>
        {{ comment_template.render_comment(comment) }}
    <template>
</turbo-stream>

{% endblock %}

{% block update_comment %}
{% import 'macros/comment.html.twig' as comment_template %}

<turbo-stream action="append" target="{{ 'replies-' ~ parent_id }}" comment="{{comment.comment.id}}">
    <template>
        {{ comment_template.render_comment(comment) }}
    <template>
</turbo-stream>

{% endblock %}
